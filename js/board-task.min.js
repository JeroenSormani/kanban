!function($){$.fn.board_task=function(task){return this.each(function(){var $task=$(this);$(document).trigger("/task/added/",task),$task.timers=[];var $projects_dropdown=$(".project .list-group",$task),estimate_records_arr=records_by_position(board.estimate_records());$task.on("save",function(t,r){if(!current_user_has_cap("write"))return!1;"undefined"==typeof r&&(r=[]);var e={task:task};e.action="save_task",e.kanban_nonce=$("#kanban_nonce").val(),"undefined"!=typeof r.comment&&(e.comment=r.comment),"undefined"!=typeof r.status_id_old&&(e.status_id_old=r.status_id_old),$.ajax({method:"POST",url:ajaxurl,data:e}).always(function(t){show_growl_msg(t)}),$(".col-tasks").same_height()}),$task.on("delete",function(){if(!current_user_has_cap("write"))return!1;var t={task:task};t.action="delete_task",t.kanban_nonce=$("#kanban_nonce").val(),t.comment="task deleted by {0}".sprintf(board.current_user().short_name),$.ajax({method:"POST",url:ajaxurl,data:t}).done(function(){delete board.task_records[task.ID],$task.slideUp("fast",function(){$task.remove(),$(".col-tasks").same_height()})}).always(function(t){show_growl_msg(t)})}),$task.on("add_project",function(){return current_user_has_cap("write")?void setTimeout(function(){var t=$(".project_title",$task),r=t.val();if("undefined"!=typeof r&&""!==r){var e=!0;for(var a in board.project_records){var s=board.project_records[a];if(r===s.title){e=!1;break}}if(e){var o={action:"save_project",post_type:"kanban_project",kanban_nonce:$("#kanban_nonce").val(),project:{title:r}};$.ajax({method:"POST",url:ajaxurl,data:o}).done(function(t){try{board.project_records[t.data.project.id]=t.data.project,task.project_id=t.data.project.id;var r='{0} added the task to the project "{1}"'.sprintf(board.current_user().short_name,t.data.project.title);$task.trigger("save",{comment:r}).trigger("populate_project")}catch(e){}}).always(function(t){show_growl_msg(t)})}}},500):!1}),$task.on("status_change",function(t,r){if(!current_user_has_cap("write"))return!1;var e=task.status_id+"",a='{0} moved the task to "{1}"'.sprintf(board.current_user().short_name,board.status_records()[r].title);task.status_id=r,$task.trigger("save",{comment:a,status_id_old:e}),$(".task-handle",$task).css({background:board.status_records()[r].color_hex})});var log_work_hour=function(t){if(!current_user_has_cap("write"))return!1;var r={task:task};r.action="add_task_hour",r.kanban_nonce=$("#kanban_nonce").val(),r.operator=t,$.ajax({method:"POST",url:ajaxurl,data:r}).always(function(t){show_growl_msg(t)})};$task.on("click",".editable-input",function(){if(!current_user_has_cap("write"))return!1;var t=$(this);t.prop("readonly")&&($(".editable-input").not(t).prop("readonly",!0),t.data("orig",t.val()),t.prop("readonly",!1),setTimeout(function(){t.focus().trigger("click").select()},100))}),$task.on("keyup",".editable-input",function(t){var r=$(this);if(13===t.keyCode&&r.trigger("blur"),27===t.keyCode){var e=r.data("orig");r.val(e).prop("readonly",!0)}}),$task.on("blur",".editable-input",function(){var t=$(this);t.prop("readonly",!0)}),$task.on("click",".delete-task",function(){return $task.trigger("delete"),!1}),$("textarea.resize",$task).autoresize({onResize:function(){$(this).addClass("autoresize")}}).trigger("keydown"),$task.on("click",".dropdown-menu-allowed-users .btn",function(){var t=$(this),r=t.val(),e="";$(".task-assigned-to-short_name",$task).not(".empty")&&(e="{0} assigned the task to {1}".sprintf(board.current_user().short_name,$(".task-assigned-to-short_name",$task).text())),task.user_id_assigned=r,$task.trigger("save",{comment:e}),$task.trigger("populate_user")}),$task.on("click",".dropdown-menu-estimates .btn",function(){var t=$(this),r=t.val();task.estimate_id=r;var e="{0} set the task estimate to {1}".sprintf(board.current_user().short_name,board.estimate_records()[r].title);$task.trigger("save",{comment:e}),$task.trigger("populate_estimate")}),$task.on("click",".btn-task-hours",function(){return $(".task-hours-operators",$task).toggleClass("active"),!1}),$task.on("click",".task-hours-operators .btn",function(){if(!current_user_has_cap("write"))return!1;var $btn=$(this),operator="+1"===$btn.val()?"+1":"-1",current=parseFloat(task.hour_count);return current=eval(current+operator),current=Math.round(1e3*current)/1e3,0>current?void(current=0):(task.hour_count=current,$task.trigger("populate_task_hours"),log_work_hour(operator),!1)}),$task.on("populate_project",function(){var t=board.project_records[task.project_id];"undefined"==typeof t&&(t={id:0,title:""}),$task.attr("data-project-id",t.id),$(".project_title",$task).val(t.title).attr("data-id",t.id)}).trigger("populate_project"),$task.on("keyup",".project_title",function(t){var r=$(this);if(13===t.keyCode)return void $task.trigger("projects_dropdown_hide");if(27===t.keyCode)return void $task.trigger("projects_dropdown_hide");$task.trigger("projects_dropdown_show"),$(".list-group-item",$task).remove();var e=r.val(),a=$.trim(e.toLowerCase());for(var s in board.project_records){var o=board.project_records[s],n=o.title,i=$.trim(n.toLowerCase());i.search(a)>-1&&$(t_card_projects_dropdown.render(o)).appendTo($projects_dropdown)}0===$(".list-group-item",$task).length&&$task.trigger("projects_dropdown_hide")}),$task.on("blur",".project_title",function(){var t=$(".btn-edit-projects",$task);if($last_clicked[0]===t[0]){var r=jQuery.Event("keyup");r.which=27,r.keyCode=27,$(this).trigger(r);var e=t.attr("data-target");$(e).modal("show")}else $task.trigger("add_project")}),$task.on("focus",".project_title",function(){if(!current_user_has_cap("write"))return!1;var t=$(this);t.trigger("keyup")}),$task.on("click",".project .list-group-item",function(){$task.trigger("projects_dropdown_hide");var t=$(this).attr("data-id");task.project_id=t,$task.trigger("save").trigger("populate_project");var r=board.project_records[t];return"undefined"==typeof r?!1:void $task.trigger("add_comment",['{0} added the task to the project "{1}"'.sprintf(board.current_user().short_name,r.post_title)])}),$task.on("click",".btn-edit-projects",function(){$task.trigger("projects_dropdown_hide")});var update_progress_bar=function(){var t=0;if("undefined"!=typeof task.estimate_id&&"undefined"!=typeof task.hour_count){var r=board.estimate_records()[task.estimate_id];"undefined"!=typeof r&&(t=100*parseFloat(task.hour_count)/parseFloat(r.hours))}var e="success";t>133?e="danger":t>100&&(e="warning"),t>100&&(t=100),$(".progress-bar",$task).css({width:t+"%"}).removeClass("progress-bar-success progress-bar-warning progress-bar-danger").addClass("progress-bar-"+e)};if($(".task_title",$task).on("keydown",function(t){return 13===t.keyCode?!1:void 0}).on("blur",function(){var t=!1;""===task.title&&(t=!0);var r=$(this);task.title=r.val();var e="{0} updated the task title".sprintf(board.current_user().short_name);t&&(e="{0} added the task".sprintf(board.current_user().short_name)),$task.trigger("save",{comment:e})}),current_user_has_cap("write"))for(var i in estimate_records_arr){var estimate=estimate_records_arr[i],$estimate=$(t_card_estimates_dropdown.render(estimate));$(".dropdown-menu-estimates",$task).append($estimate)}if($task.on("populate_estimate",function(){var t=board.estimate_records()[task.estimate_id],r="--";"undefined"!=typeof t&&(r=t.title);var e={estimate:r},a=$(t_card_estimate.render(e));$(".btn-estimate",$task).replaceWith(a),update_progress_bar()}).trigger("populate_estimate"),current_user_has_cap("write"))for(var i in board.allowed_users()){var user=board.allowed_users()[i];if(user_has_cap("write",user)){var $user=$(t_card_users_dropdown.render(user));$(".dropdown-menu-allowed-users",$task).append($user)}}$task.on("populate_user",function(){var t;try{t=board.allowed_users()[task.user_id_assigned],$task.attr("data-assigned-to",task.user_id_assigned)}catch(r){}"undefined"==typeof t&&(t={short_name:"-- Assign --",initials:"--"});var e=$(t_card_user_assigned_to.render(t));$(".btn-assigned-to",$task).replaceWith(e)}).trigger("populate_user"),$task.on("populate_task_hours",function(){task.hour_count=parseFloat(task.hour_count),task.hour_count<0&&(task.hour_count=0);var t;t=format_hours(task.hour_count);var r={hour_count:t},e=$(t_card_task_hours.render(r));$(".btn-task-hours",$task).replaceWith(e),update_progress_bar()}).trigger("populate_task_hours"),$task.on("projects_dropdown_show",function(){$projects_dropdown.show(),$task.addClass("active")}),$task.on("projects_dropdown_hide",function(){$projects_dropdown.hide(),$task.removeClass("active")})})}}(jQuery);