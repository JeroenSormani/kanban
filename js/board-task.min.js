!function($){$.fn.board_task=function(task){return this.each(function(){var $task=$(this);$task.timers=[];var $projects_dropdown=$(".project .list-group",$task);$task.on("save",function(t,e){"undefined"==typeof e&&(e=[]);var a={task:task};a.action="save_task",a.kanban_nonce=$("#kanban_nonce").val(),"undefined"!=typeof e.comment&&(a.comment=e.comment),"undefined"!=typeof e.status_id_old&&(a.status_id_old=e.status_id_old),$.ajax({method:"POST",url:ajaxurl,data:a}).always(function(t){show_growl_msg(t)}),$(".col-tasks").same_height()}),$task.on("delete",function(t){var e={task:task};e.action="delete_task",e.kanban_nonce=$("#kanban_nonce").val(),e.comment="task deleted by {0}".sprintf(current_user.short_name),$.ajax({method:"POST",url:ajaxurl,data:e}).done(function(t){delete task_records[task.ID],$task.slideUp("fast",function(){$task.remove(),$(".col-tasks").same_height()})}).always(function(t){show_growl_msg(t)})}),$task.on("add_project",function(){setTimeout(function(){var t=$(".project_title",$task),e=t.val();if("undefined"!=typeof e&&""!=e){var a=!0;for(var r in project_records){var s=project_records[r];if(e==s.title){a=!1;break}}if(a){var o={action:"save_project",post_type:"kanban_project",kanban_nonce:$("#kanban_nonce").val(),project:{title:e}};$.ajax({method:"POST",url:ajaxurl,data:o}).done(function(t){try{project_records[t.data.project.id]=t.data.project,task.project_id=t.data.project.id;var e='{0} added the task to the project "{1}"'.sprintf(current_user.short_name,t.data.project.post_title);$task.trigger("save",{comment:e}).trigger("populate_project")}catch(a){}}).always(function(t){show_growl_msg(t)})}}},500)}),$task.on("status_change",function(t,e){var a=task.status_id+"",r='{0} moved the task to "{1}"'.sprintf(current_user.short_name,status_records[e].title);task.status_id=e,$task.trigger("save",{comment:r,status_id_old:a}),$(".task-handle",$task).css({background:status_records[e].color_hex})});var log_work_hour=function(t){var e={task:task};e.action="add_task_hour",e.kanban_nonce=$("#kanban_nonce").val(),e.operator=t,$.ajax({method:"POST",url:ajaxurl,data:e}).always(function(t){show_growl_msg(t)})};$task.on("click",".editable-input",function(){var t=$(this);t.prop("readonly")&&($(".editable-input").not(t).prop("readonly",!0),t.data("orig",t.val()),t.prop("readonly",!1),setTimeout(function(){t.focus().trigger("click").select()},100))}),$task.on("keyup",".editable-input",function(t){var e=$(this);if(13==t.keyCode&&e.trigger("blur"),27==t.keyCode){var a=e.data("orig");e.val(a).prop("readonly",!0)}}),$task.on("blur",".editable-input",function(t){var e=$(this);e.prop("readonly",!0)}),$task.on("click",".delete-task",function(){return $task.trigger("delete"),!1}),$("textarea.resize",$task).autoresize({onResize:function(){$(this).addClass("autoresize")}}).trigger("keydown"),$task.on("click",".dropdown-menu-allowed-users .btn",function(){var t=$(this),e=t.val(),a="{0} assigned the task to {1}".sprintf(current_user.short_name,$(".task-assigned-to-short_name",$task).text());task.user_id_assigned=e,$task.trigger("save",{comment:a}),$task.trigger("populate_user")}),$task.on("click",".dropdown-menu-estimates .btn",function(){var t=$(this),e=t.val();task.estimate_id=e;var a="{0} set the task estimate to {1}".sprintf(current_user.short_name,estimate_records[e].title);$task.trigger("save"),$task.trigger("populate_estimate")}),$task.on("click",".btn-task-hours",function(){return $(".task-hours-operators",$task).toggleClass("active"),!1}),$task.on("click",".task-hours-operators .btn",function(){var $btn=$(this),operator=$btn.val(),current=parseFloat(task.hour_count);return current=eval(current+operator),current=Math.round(1e3*current)/1e3,0>current&&(current=0),task.hour_count=current,$task.trigger("populate_task_hours"),log_work_hour(operator),!1}),$task.on("populate_project",function(){var t=project_records[task.project_id];"undefined"==typeof t&&(t={id:0,title:""}),$task.attr("data-project-id",t.id),$(".project_title",$task).val(t.title).attr("data-id",t.id)}),$task.trigger("populate_project"),$task.on("keyup",".project_title",function(t){var e=$(this),a=e.val();if(13==t.keyCode)return void $projects_dropdown.hide();if(27==t.keyCode)return void $projects_dropdown.hide();$projects_dropdown.show(),$(".list-group-item",$task).remove();var r=e.val(),s=$.trim(r.toLowerCase());for(var o in project_records){var n=project_records[o],i=n.title,d=$.trim(i.toLowerCase());d.search(s)>-1&&$(t_card_projects_dropdown.render(n)).appendTo($projects_dropdown)}0==$(".list-group-item",$task).length&&$projects_dropdown.hide()}),$task.on("blur",".project_title",function(t){var e=$(".btn-edit-projects",$task);if($last_clicked[0]==e[0]){var t=jQuery.Event("keyup");t.which=27,t.keyCode=27,$(this).trigger(t);var a=e.attr("data-target");$(a).modal("show")}else $task.trigger("add_project")}),$task.on("focus",".project_title",function(t){var e=$(this);e.trigger("keyup")}),$task.on("click",".project .list-group-item",function(){$projects_dropdown.hide();var t=$(this).attr("data-id");task.project_id=t,$task.trigger("save").trigger("populate_project");var e=project_records[t];return"undefined"==typeof e?!1:void $task.trigger("add_comment",['{0} added the task to the project "{1}"'.sprintf(current_user.short_name,e.post_title)])}),$task.on("click",".btn-edit-projects",function(){$projects_dropdown.hide()});var update_progress_bar=function(){var t=0;if("undefined"!=typeof task.estimate_id&&"undefined"!=typeof task.hour_count){var e=estimate_records[task.estimate_id];"undefined"!=typeof e&&(t=100*parseFloat(task.hour_count)/parseFloat(e.slug))}var a="success";t>133?a="danger":t>100&&(a="warning"),t>100&&(t=100),$(".progress-bar",$task).css({width:t+"%"}).removeClass("progress-bar-success progress-bar-warning progress-bar-danger").addClass("progress-bar-"+a)};$(".task_title",$task).on("keydown",function(t){var e=$(this);return 13==t.keyCode?!1:void 0}).on("blur",function(t){var e=$(this);task.title=e.val();var a="{0} updated the task title".sprintf(current_user.short_name);$task.trigger("save",{comment:a})});for(var id in estimate_records){var estimate=estimate_records[id],$estimate=$(t_card_estimates_dropdown.render(estimate));$(".dropdown-menu-estimates",$task).append($estimate)}$task.on("populate_estimate",function(){var t=estimate_records[task.estimate_id];if("undefined"==typeof t)var e="--";else var e=t.name;var a={estimate:e},r=$(t_card_estimate.render(a));$(".btn-estimate",$task).replaceWith(r),update_progress_bar()}).trigger("populate_estimate");for(var i in allowed_users){var user=allowed_users[i],$user=$(t_card_users_dropdown.render(user));$(".dropdown-menu-allowed-users",$task).append($user)}$task.on("populate_user",function(){var t;try{var t=allowed_users[task.user_id_assigned];$task.attr("data-assigned-to",task.user_id_assigned)}catch(e){}"undefined"==typeof t&&(t={data:{short_name:"-- Assign --",initials:"--"}});var a=$(t_card_user_assigned_to.render(t));$(".btn-assigned-to",$task).replaceWith(a)}).trigger("populate_user"),$task.on("populate_task_hours",function(){task.hour_count=parseFloat(task.hour_count),task.hour_count<0&&(task.hour_count=0);var t;t=format_hours(task.hour_count);var e={hour_count:t},a=$(t_card_task_hours.render(e));$(".btn-task-hours",$task).replaceWith(a),update_progress_bar()}).trigger("populate_task_hours")})}}(jQuery);